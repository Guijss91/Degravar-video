{% extends "base.html" %}
{% block content %}
<div class="flex-center-container">
  <div class="main-header">
    <div class="main-title">
      <i class="fas fa-video"></i> Transcri√ß√£o Chat
    </div>
    <div class="main-subtitle">
      Extraia √°udio de v√≠deos e gere transcri√ß√µes inteligentes
    </div>
  </div>
</div>

<div class="centered-columns">
  <div style="flex:2; margin-right:12px;">
    <div class="flex-center-container">
      <div class="card">
        <div class="card-title">
          <i class="fas fa-cloud-upload-alt"></i> Upload de V√≠deo
        </div>
      </div>
    </div>

    <div class="flex-center-container">
      <div class="upload-area">
        <form id="uploadForm">
          <input type="file" id="videoFile" name="file" accept=".mp4,.mkv,.avi,.mov"/>
          <p style="margin-top:10px;color:#718096;">Tamanho m√°ximo recomendado: 500MB</p>
          <button type="submit" class="btn-primary" style="margin-top:12px;">üöÄ Extrair √Åudio e Enviar</button>
        </form>
      </div>
    </div>

    <div class="flex-center-container" id="previewContainer" style="display:none;">
      <div class="video-container">
        <div class="card-title">
          <i class="fas fa-play-circle"></i> Preview do V√≠deo
        </div>
        <video id="videoPreview" controls style="width:100%;max-height:420px;border-radius:12px;"></video>
      </div>
    </div>

    <div id="progressArea"></div>

    <div class="flex-center-container" id="enviarSolarContainer" style="display:none;">
      <div style="display:flex;justify-content:center;width:100%;">
        <button id="btnEnviarSolar" class="btn-primary">üöÄ Enviar para o SOLAR</button>
      </div>
    </div>
  </div>

  <div style="flex:1;">
    <div class="flex-center-container" id="statsBox" style="display:none;">
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-value" id="fileSize">0</div>
          <div class="stat-label">MB</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="fileFormat">MP4</div>
          <div class="stat-label">Formato</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="chatHeader" class="flex-center-container" style="display:none;">
  <div class="card">
    <div class="card-title">
      <i class="fas fa-comments"></i> Transcri√ß√£o (Chat)
    </div>
  </div>
</div>

<div class="flex-center-container" id="statsTranscricao" style="display:none;">
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-value" id="numMensagens">0</div>
      <div class="stat-label">Mensagens</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="numParticipantes">0</div>
      <div class="stat-label">Participantes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="numPalavras">0</div>
      <div class="stat-label">Palavras</div>
    </div>
  </div>
</div>

<div class="flex-center-container" id="chatContainer" style="display:none;">
  <div class="chat-container" id="chatMessages"></div>
</div>

<script>
  const uploadForm = document.getElementById("uploadForm");
  const videoInput = document.getElementById("videoFile");
  const progressArea = document.getElementById("progressArea");
  const previewContainer = document.getElementById("previewContainer");
  const statsBox = document.getElementById("statsBox");
  const fileSizeEl = document.getElementById("fileSize");
  const fileFormatEl = document.getElementById("fileFormat");
  const videoPreview = document.getElementById("videoPreview");
  const chatHeader = document.getElementById("chatHeader");
  const chatContainer = document.getElementById("chatContainer");
  const chatMessages = document.getElementById("chatMessages");
  const statsTranscricao = document.getElementById("statsTranscricao");
  const numMensagens = document.getElementById("numMensagens");
  const numParticipantes = document.getElementById("numParticipantes");
  const numPalavras = document.getElementById("numPalavras");
  const enviarSolarContainer = document.getElementById("enviarSolarContainer");
  const btnEnviarSolar = document.getElementById("btnEnviarSolar");

  let utterancesMem = [];

  function showProcessing(message) {
    progressArea.innerHTML = `
      <div class="flex-center-container">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-cogs"></i> Processando...
          </div>
          <div class="custom-progress"></div>
          <p style="text-align:center; margin-top:1rem;">
            <span class="loading-spinner"></span> ${message}
          </p>
        </div>
      </div>`;
  }

  function showSuccess(message) {
    progressArea.innerHTML = `
      <div class="flex-center-container">
        <div class="custom-success">
          <i class="fas fa-check-circle"></i> ${message}
        </div>
      </div>`;
  }

  function showError(message) {
    progressArea.innerHTML = `
      <div class="flex-center-container">
        <div class="custom-error">
          <i class="fas fa-times-circle"></i> ${message}
        </div>
      </div>`;
  }

  function showWarning(message) {
    progressArea.innerHTML = `
      <div class="flex-center-container">
        <div class="custom-warning">
          <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
      </div>`;
  }

  videoInput.addEventListener("change", () => {
    const f = videoInput.files && videoInput.files;
    if (!f) return;
    fileSizeEl.textContent = (f.size / (1024*1024)).toFixed(1);
    const ext = f.name.split(".").pop().toUpperCase();
    fileFormatEl.textContent = ext;
    statsBox.style.display = "block";

    // preview
    const url = URL.createObjectURL(f);
    videoPreview.src = url;
    previewContainer.style.display = "block";
  });

  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const f = videoInput.files && videoInput.files;
    if (!f) {
      showWarning("Selecione um v√≠deo antes de enviar.");
      return;
    }

    showProcessing("Extraindo √°udio do v√≠deo...");
    const formData = new FormData();
    formData.append("file", f);

    try {
      // 1) extrair e enviar ao n8n
      const resp = await fetch("/processar", {
        method: "POST",
        body: formData
      });

      if (!resp.ok) {
        const txt = await resp.text();
        showError("Erro ao processar v√≠deo: " + resp.status + " " + txt);
        return;
      }

      const data = await resp.json();
      const utterances = data.utterances || [];
      if (!utterances.length) {
        showWarning("Nenhuma transcri√ß√£o encontrada.");
        utterancesMem = [];
        enviarSolarContainer.style.display = "none";
        chatHeader.style.display = "none";
        chatContainer.style.display = "none";
        statsTranscricao.style.display = "none";
        return;
      }

      utterancesMem = utterances.slice();

      showSuccess("√Åudio enviado e processado com sucesso!");

      // 2) exibir chat e estat√≠sticas
      chatHeader.style.display = "block";
      chatContainer.style.display = "block";
      statsTranscricao.style.display = "block";
      enviarSolarContainer.style.display = "block";

      // stats
      numMensagens.textContent = utterancesMem.length.toString();
      const speakersSet = new Set(utterancesMem.map(u => u.speaker));
      numParticipantes.textContent = speakersSet.size.toString();
      const palavras = utterancesMem.reduce((acc,u)=> acc + (u.text || "").trim().split(/\s+/).filter(Boolean).length, 0);
      numPalavras.textContent = palavras.toString();

      // cores fixas por speaker
      const colors = ["#0e258d","#764ba2","#4facfe","#43e97b","#fa709a","#a8edea","#ff9a9e"];
      const speakerList = Array.from(speakersSet).sort();
      const colorMap = {};
      speakerList.forEach((sp, i)=> colorMap[sp] = colors[i % colors.length]);

      // mensagens
      chatMessages.innerHTML = "";
      utterancesMem.forEach(u => {
        const icon = u.speaker === "SPEAKER_00" ? "fas fa-user" : (u.speaker === "SPEAKER_01" ? "fas fa-user-tie" : "fas fa-user-circle");
        const color = colorMap[u.speaker] || "#0e258d";
        const div = document.createElement("div");
        div.className = "chat-message";
        div.style.background = color;
        div.style.color = "white";
        div.innerHTML = `
          <div class="speaker-label">
            <i class="${icon}"></i> ${u.speaker}
          </div>
          <div class="message-text">${(u.text || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
        `;
        chatMessages.appendChild(div);
      });

    } catch(err) {
      showError("Erro no processamento: " + err);
    }
  });

  btnEnviarSolar.addEventListener("click", async () => {
    if (!utterancesMem.length) {
      showWarning("Nenhuma transcri√ß√£o para enviar.");
      return;
    }

    progressArea.innerHTML = `
      <div class="flex-center-container">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-paper-plane"></i> Enviando...
          </div>
          <p style="text-align:center;">
            <span class="loading-spinner"></span> Enviando transcri√ß√£o para o SOLAR...
          </p>
        </div>
      </div>
    `;

    const finalTranscricao = utterancesMem.map(u => ({speaker: u.speaker, text: u.text}));

    try {
      const resp = await fetch("/enviar_solar", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({transcricao: finalTranscricao})
      });
      const data = await resp.json();
      if (resp.ok && data.ok) {
        showSuccess("Transcri√ß√£o enviada com sucesso!");
      } else {
        showError("Erro ao enviar transcri√ß√£o: " + (data.status || resp.status));
      }
    } catch(err) {
      showError("Erro ao enviar transcri√ß√£o: " + err);
    }
  });
</script>
{% endblock %}
